---
title: 主控台控制代碼
description: 主控台程序會使用控制代碼來存取其主控台的輸入和畫面緩衝區，包括 GetStdHandle、CreateFile 或 CreateConsoleScreenBuffer 函式。
author: miniksa
ms.author: miniksa
ms.topic: conceptual
keywords: 主控台, 字元模式應用程式, 命令列應用程式, 終端機應用程式, 主控台 api
MS-HAID:
- '\_win32\_console\_handles'
- base.console\_handles
- consoles.console\_handles
MSHAttr:
- PreferredSiteName:MSDN
- PreferredLib:/library/windows/desktop
ms.assetid: dc723046-b3e9-418a-b386-79be411e5ac8
ms.localizationpriority: high
ms.openlocfilehash: acc7d65e15451fc2804dc1782644c1ccbaa30e28
ms.sourcegitcommit: 508e93bc83b4bca6ce678f88ab081d66b95d605c
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 12/04/2020
ms.locfileid: "96420237"
---
# <a name="console-handles"></a><span data-ttu-id="43c3f-104">主控台控制代碼</span><span class="sxs-lookup"><span data-stu-id="43c3f-104">Console Handles</span></span>

<span data-ttu-id="43c3f-105">主控台程序會使用控制代碼來存取其主控台的輸入和畫面緩衝區。</span><span class="sxs-lookup"><span data-stu-id="43c3f-105">A console process uses handles to access the input and screen buffers of its console.</span></span> <span data-ttu-id="43c3f-106">程序可以使用 [**GetStdHandle**](getstdhandle.md)、[**CreateFile**](https://msdn.microsoft.com/library/windows/desktop/aa363858)，或 [**CreateConsoleScreenBuffer**](createconsolescreenbuffer.md) 函式來開啟其中一個控制代碼。</span><span class="sxs-lookup"><span data-stu-id="43c3f-106">A process can use the [**GetStdHandle**](getstdhandle.md), [**CreateFile**](https://msdn.microsoft.com/library/windows/desktop/aa363858), or [**CreateConsoleScreenBuffer**](createconsolescreenbuffer.md) function to open one of these handles.</span></span>

<span data-ttu-id="43c3f-107">[**GetStdHandle**](getstdhandle.md) 函式提供一種機制，可用來擷取與程序相關聯的標準輸入 (`STDIN`)、標準輸出 (`STDOUT`) 和標準錯誤 (`STDERR`) 控制代碼。</span><span class="sxs-lookup"><span data-stu-id="43c3f-107">The [**GetStdHandle**](getstdhandle.md) function provides a mechanism for retrieving the standard input (`STDIN`), standard output (`STDOUT`), and standard error (`STDERR`) handles associated with a process.</span></span> <span data-ttu-id="43c3f-108">系統會在建立主控台期間建立這些控制代碼。</span><span class="sxs-lookup"><span data-stu-id="43c3f-108">During console creation, the system creates these handles.</span></span> <span data-ttu-id="43c3f-109">一開始，`STDIN` 是主控台輸入緩衝區的控制代碼，而 `STDOUT` 和 `STDERR` 是主控台作用中畫面緩衝區的控制代碼。</span><span class="sxs-lookup"><span data-stu-id="43c3f-109">Initially, `STDIN` is a handle to the console's input buffer, and `STDOUT` and `STDERR` are handles of the console's active screen buffer.</span></span> <span data-ttu-id="43c3f-110">不過，[**SetStdHandle**](setstdhandle.md) 函式可以藉由變更與 `STDIN`、`STDOUT` 或 `STDERR` 相關聯的控制代碼，來重新導向標準控制代碼。</span><span class="sxs-lookup"><span data-stu-id="43c3f-110">However, the [**SetStdHandle**](setstdhandle.md) function can redirect the standard handles by changing the handle associated with `STDIN`, `STDOUT`, or `STDERR`.</span></span> <span data-ttu-id="43c3f-111">因為父系的標準控制代碼會由任何子程序繼承，所以後續對 **GetStdHandle**  發出的呼叫都會傳回重新導向的控制代碼。</span><span class="sxs-lookup"><span data-stu-id="43c3f-111">Because the parent's standard handles are inherited by any child process, subsequent calls to **GetStdHandle** return the redirected handle.</span></span> <span data-ttu-id="43c3f-112">因此，**GetStdHandle** 傳回的控制代碼可能會參考主控台 I/O 以外的項目。</span><span class="sxs-lookup"><span data-stu-id="43c3f-112">A handle returned by **GetStdHandle** may, therefore, refer to something other than console I/O.</span></span> <span data-ttu-id="43c3f-113">例如，在建立子程序之前，父程序可以使用 **SetStdHandle** 將管道控制代碼設定為子程序繼承的 `STDIN` 控制代碼。</span><span class="sxs-lookup"><span data-stu-id="43c3f-113">For example, before creating a child process, a parent process can use **SetStdHandle** to set a pipe handle to be the `STDIN` handle that is inherited by the child process.</span></span> <span data-ttu-id="43c3f-114">當子程序呼叫 **GetStdHandle** 時，即可取得管道控制代碼。</span><span class="sxs-lookup"><span data-stu-id="43c3f-114">When the child process calls **GetStdHandle**, it gets the pipe handle.</span></span> <span data-ttu-id="43c3f-115">這表示父程序可以控制子程序的標準控制代碼。</span><span class="sxs-lookup"><span data-stu-id="43c3f-115">This means that the parent process can control the standard handles of the child process.</span></span> <span data-ttu-id="43c3f-116">**GetStdHandle** 傳回的控制代碼都具有 `GENERIC_READ | GENERIC_WRITE` 存取權 (除非已使用 **SetStdHandle** 將標準控制代碼設定為具有較低的存取權)。</span><span class="sxs-lookup"><span data-stu-id="43c3f-116">The handles returned by **GetStdHandle** have `GENERIC_READ | GENERIC_WRITE` access unless **SetStdHandle** has been used to set the standard handle to have lesser access.</span></span>

<span data-ttu-id="43c3f-117">[**GetStdHandle**](getstdhandle.md) 所傳回的控制代碼值不是 0、1 和 2，因此 Stdio.h 中的標準預先定義資料流常數 (`STDIN`、`STDOUT` 和 `STDERR`) 不能用在需要主控台控制代碼的函式中。</span><span class="sxs-lookup"><span data-stu-id="43c3f-117">The value of the handles returned by [**GetStdHandle**](getstdhandle.md) are not 0, 1, and 2, so the standard predefined stream constants in Stdio.h (`STDIN`, `STDOUT`, and `STDERR`) cannot be used in functions that require a console handle.</span></span>

<span data-ttu-id="43c3f-118">[**CreateFile**](https://msdn.microsoft.com/library/windows/desktop/aa363858) 函式可讓程序取得其主控台輸入緩衝區和作用中畫面緩衝區的控制代碼，即使 `STDIN` 和 `STDOUT` 已經重新導向也一樣。</span><span class="sxs-lookup"><span data-stu-id="43c3f-118">The [**CreateFile**](https://msdn.microsoft.com/library/windows/desktop/aa363858) function enables a process to get a handle to its console's input buffer and active screen buffer, even if `STDIN` and `STDOUT` have been redirected.</span></span> <span data-ttu-id="43c3f-119">若要開啟主控台輸入緩衝區的控制代碼，請在對 **CreateFile** 發出的呼叫中指定 `CONIN$` 值。</span><span class="sxs-lookup"><span data-stu-id="43c3f-119">To open a handle to a console's input buffer, specify the `CONIN$` value in a call to **CreateFile**.</span></span> <span data-ttu-id="43c3f-120">在對 **CreateFile** 發出的呼叫中指定 `CONOUT$` 值，可開啟主控台作用中畫面緩衝區的控制代碼。</span><span class="sxs-lookup"><span data-stu-id="43c3f-120">Specify the `CONOUT$` value in a call to **CreateFile** to open a handle to a console's active screen buffer.</span></span> <span data-ttu-id="43c3f-121">**CreateFile** 可讓您指定所傳回控制代碼的讀取/寫入存取權。</span><span class="sxs-lookup"><span data-stu-id="43c3f-121">**CreateFile** enables you to specify the read/write access of the handle that it returns.</span></span>

<span data-ttu-id="43c3f-122">[**CreateConsoleScreenBuffer**](createconsolescreenbuffer.md) 函式會建立新的畫面緩衝區，並傳回控制代碼。</span><span class="sxs-lookup"><span data-stu-id="43c3f-122">The [**CreateConsoleScreenBuffer**](createconsolescreenbuffer.md) function creates a new screen buffer and returns a handle.</span></span> <span data-ttu-id="43c3f-123">此控制代碼可用於任何接受主控台輸出控制代碼的函式。</span><span class="sxs-lookup"><span data-stu-id="43c3f-123">This handle can be used in any function that accepts a handle to console output.</span></span> <span data-ttu-id="43c3f-124">若要讓新的畫面緩衝區開始作用 (顯示)，則必須在呼叫 [**SetConsoleActiveScreenBuffer**](setconsoleactivescreenbuffer.md) 函式時指定其控制代碼。</span><span class="sxs-lookup"><span data-stu-id="43c3f-124">The new screen buffer is not active (displayed) until its handle is specified in a call to the [**SetConsoleActiveScreenBuffer**](setconsoleactivescreenbuffer.md) function.</span></span> <span data-ttu-id="43c3f-125">請注意，變更作用中畫面緩衝區不會影響 [**GetStdHandle**](getstdhandle.md) 所傳回的控制代碼。</span><span class="sxs-lookup"><span data-stu-id="43c3f-125">Note that changing the active screen buffer does not affect the handle returned by [**GetStdHandle**](getstdhandle.md).</span></span> <span data-ttu-id="43c3f-126">同樣地，使用 [**SetStdHandle**](setstdhandle.md) 變更 `STDOUT` 控制代碼，並不會影響作用中的畫面緩衝區。</span><span class="sxs-lookup"><span data-stu-id="43c3f-126">Similarly, using [**SetStdHandle**](setstdhandle.md) to change the `STDOUT` handle does not affect the active screen buffer.</span></span>

<span data-ttu-id="43c3f-127">當任何主控台函式需要主控台輸入緩衝區的控制代碼或主控台畫面緩衝區的控制代碼時，您都可以使用 [**CreateFile**](https://msdn.microsoft.com/library/windows/desktop/aa363858) 和 [**CreateConsoleScreenBuffer**](createconsolescreenbuffer.md) 所傳回的主控台控制代碼。</span><span class="sxs-lookup"><span data-stu-id="43c3f-127">Console handles returned by [**CreateFile**](https://msdn.microsoft.com/library/windows/desktop/aa363858) and [**CreateConsoleScreenBuffer**](createconsolescreenbuffer.md) can be used in any of the console functions that require a handle to a console's input buffer or of a console screen buffer.</span></span> <span data-ttu-id="43c3f-128">如果主控台函式尚未重新導向為參考主控台 I/O 以外的項目，主控台函式也可使用 [**GetStdHandle**](getstdhandle.md) 所傳回的控制代碼。</span><span class="sxs-lookup"><span data-stu-id="43c3f-128">Handles returned by [**GetStdHandle**](getstdhandle.md) can be used by the console functions if they have not been redirected to refer to something other than console I/O.</span></span> <span data-ttu-id="43c3f-129">不過，如果已將標準控制代碼重新導向為參考檔案或管道，則只有 [**ReadFile**](https://msdn.microsoft.com/library/windows/desktop/aa365467) 和 [**WriteFile**](https://msdn.microsoft.com/library/windows/desktop/aa365747) 函式可以使用控制代碼。</span><span class="sxs-lookup"><span data-stu-id="43c3f-129">If a standard handle has been redirected to refer to a file or a pipe, however, the handle can only be used by the [**ReadFile**](https://msdn.microsoft.com/library/windows/desktop/aa365467) and [**WriteFile**](https://msdn.microsoft.com/library/windows/desktop/aa365747) functions.</span></span> <span data-ttu-id="43c3f-130">[**GetFileType**](https://docs.microsoft.com/windows/win32/api/fileapi/nf-fileapi-getfiletype) 可以協助您判斷控制代碼所參考的裝置類型。</span><span class="sxs-lookup"><span data-stu-id="43c3f-130">[**GetFileType**](https://docs.microsoft.com/windows/win32/api/fileapi/nf-fileapi-getfiletype) can assist in determining what device type the handle refers to.</span></span> <span data-ttu-id="43c3f-131">主控台控制代碼會顯示為 `FILE_TYPE_CHAR`。</span><span class="sxs-lookup"><span data-stu-id="43c3f-131">A console handle presents as `FILE_TYPE_CHAR`.</span></span>

<span data-ttu-id="43c3f-132">程序可以使用 [**DuplicateHandle**](https://msdn.microsoft.com/library/windows/desktop/ms724251) 函式建立重複的主控台控制代碼，但其存取權或繼承性可以與原本控制代碼不同。</span><span class="sxs-lookup"><span data-stu-id="43c3f-132">A process can use the [**DuplicateHandle**](https://msdn.microsoft.com/library/windows/desktop/ms724251) function to create a duplicate console handle that has different access or inheritability from the original handle.</span></span> <span data-ttu-id="43c3f-133">不過，請注意，程序建立的重複主控台控制代碼僅能供自己使用。</span><span class="sxs-lookup"><span data-stu-id="43c3f-133">Note, however, that a process can create a duplicate console handle only for its own use.</span></span> <span data-ttu-id="43c3f-134">這與其他控制代碼類型 (例如檔案、管道或 Mutex 物件) 不同，**DuplicateHandle** 可以建立對不同程序有效的副本。</span><span class="sxs-lookup"><span data-stu-id="43c3f-134">This differs from other handle types (such as file, pipe, or mutex objects), for which **DuplicateHandle** can create a duplicate that is valid for a different process.</span></span>
<span data-ttu-id="43c3f-135">主控台的存取權必須在 [建立](creation-of-a-console.md)其他程序期間共用，或是由其他程序透過 [**AttachConsole**](attachconsole.md) 機制來要求。</span><span class="sxs-lookup"><span data-stu-id="43c3f-135">Access to a console must be shared during [creation](creation-of-a-console.md) of the other process or may be requested by the other process through the [**AttachConsole**](attachconsole.md) mechanism.</span></span>

<span data-ttu-id="43c3f-136">若要關閉主控台控制代碼，程序可以使用 [**CloseHandle**](https://msdn.microsoft.com/library/windows/desktop/ms724211) 函式。</span><span class="sxs-lookup"><span data-stu-id="43c3f-136">To close a console handle, a process can use the [**CloseHandle**](https://msdn.microsoft.com/library/windows/desktop/ms724211) function.</span></span>
